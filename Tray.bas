Attribute VB_Name = "Tray"
Option Explicit
'//////////////////////////////////////////////////////////////////////////////
'@@summary
'@@require
'@@reference
'@@license
'@@author
'@@create
'@@modify

'//////////////////////////////////////////////////////////////////////////////
'//
'//      公有声明
'//
'//////////////////////////////////////////////////////////////////////////////
Public Declare Function Shell_NotifyIcon Lib "shell32.dll" (ByVal dwMessage As Long, lpData As NOTIFYICONDATA) As Long

Public Const NIM_ADD = &H0                     '在任务栏中增加一个图标
Public Const NIM_DELETE = &H2                  '删除任务栏中的一个图标
Public Const NIM_MODIFY = &H1                  '修改任务栏中个图标信息
Public Const NIF_ICON = &H2                    '
Public Const NIF_MESSAGE = &H1                 'NOTIFYICONDATA结构中uFlags的控制信息
Public Const NIF_TIP = &H4
'
Private Const WM_MOUSEMOVE = &H200

Public Type NOTIFYICONDATA
  cbSize As Long                        '该数据结构的大小
  hwnd As Long                          '处理任务栏中图标的窗口句柄
  uID As Long                           '定义的任务栏中图标的标识
  uFlags As Long                        '任务栏图标功能控制，可以是以下值的组合（一般全包括）
                                        'NIF_MESSAGE 表示发送控制消息；
                                        'NIF_ICON表示显示控制栏中的图标；
                                        'NIF_TIP表示任务栏中的图标有动态提示。
  uCallbackMessage As Long '任务栏图标通过它与用户程序交换消息，处理该消息的窗口由hWnd决定
  hIcon As Long '任务栏中的图标的控制句柄
  szTip As String * 64 '图标的提示信息
End Type
Public p_Tray As NOTIFYICONDATA
'------------------------------------------------------------------------------
'       公有常量
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       公有数据类型
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       公有变量
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       公有API
'------------------------------------------------------------------------------

'//////////////////////////////////////////////////////////////////////////////
'//
'//      私有声明
'//
'//////////////////////////////////////////////////////////////////////////////

'------------------------------------------------------------------------------
'       私有常量
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       私有数据类型
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       私有变量
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       属性变量
'------------------------------------------------------------------------------

'------------------------------------------------------------------------------
'       私有API
'------------------------------------------------------------------------------
'*************************************************************************
'to托盘过程
'*************************************************************************
Public Function toTray(frm As Form, sz As String, force As Boolean)
    Debug.Print frm.WindowState

    If force = True Then
        GoTo Tray

    ElseIf frm.WindowState = 1 Then
        GoTo Tray
    Else

        Exit Function

    End If

Tray:
    p_Tray.cbSize = Len(p_Tray)
    p_Tray.uID = vbNull
    p_Tray.hwnd = frm.hwnd
    p_Tray.uFlags = NIF_TIP Or NIF_MESSAGE Or NIF_ICON
    p_Tray.uCallbackMessage = WM_MOUSEMOVE   '因此使用Form的Move事件处理恢复托盘
    p_Tray.hIcon = frm.Icon
    p_Tray.szTip = sz & vbNullChar
    Shell_NotifyIcon NIM_ADD, p_Tray
    frm.Hide
End Function
'*************************************************************************
'处理恢复托盘过程一般如下
'*************************************************************************
'Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
'    Dim msg As Long
'    msg = X / 15
'    If msg = WM_LBUTTONDBLCLK Then
'        Me.WindowState = 0
'        Me.Show
'        Shell_NotifyIcon NIM_DELETE, p_Tray
'    End If
'End Sub
'*************************************************************************

'//////////////////////////////////////////////////////////////////////////////
'//
'//      事件处理
'//
'//////////////////////////////////////////////////////////////////////////////

'//////////////////////////////////////////////////////////////////////////////
'//
'//      私有属性
'//
'//////////////////////////////////////////////////////////////////////////////

'//////////////////////////////////////////////////////////////////////////////
'//
'//      私有方法
'//
'//////////////////////////////////////////////////////////////////////////////

'//////////////////////////////////////////////////////////////////////////////
'//
'//      公有属性
'//
'//////////////////////////////////////////////////////////////////////////////

'//////////////////////////////////////////////////////////////////////////////
'//
'//      公有方法
'//
'//////////////////////////////////////////////////////////////////////////////

